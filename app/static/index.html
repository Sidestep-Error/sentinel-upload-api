<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sentinel Upload API</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="grid"></div>
    <div class="glow"></div>

    <header>
      <div class="nav">
        <div class="brand">
          <img src="/static/assets/sidestep-logo.png" alt="Sidestep Error logo" />
          <div>
            <div>Sentinel Upload API</div>
            <small>Secure DevSecOps Demo</small>
          </div>
        </div>
        <div class="pill">build → scan → deploy</div>
      </div>
    </header>

    <main>
      <section class="hero">
        <div>
          <h1>Secure Uploads, Zero Guesswork</h1>
          <p>
            A hardened file intake pipeline built for DevSecOps. Validate types,
            enforce policy, and ship with confidence.
          </p>
        </div>
        <div class="panel">
          <img
            class="logo-hero"
            src="/static/assets/sidestep-logo.png"
            alt="Sidestep Error mark"
          />
        </div>
      </section>

      <section id="upload" class="upload-layout">
        <div class="panel upload">
          <h2>Upload Console</h2>
          <div class="dropzone" id="dropzone">
            <p>Drop a file here or click to choose</p>
            <label for="file-input">Choose file</label>
            <input id="file-input" type="file" />
          </div>
          <div class="meta">
            <div>Allowed types: PDF, PNG, JPG, TXT, MD, CSV, DOC(X), XLS(X), PPT(X), ODT, ODS, ODP</div>
            <div>Endpoint: <code>/upload</code></div>
          </div>
          <button class="button" id="upload-btn" type="button">Upload now</button>
          <div class="status" id="status">Waiting for input…</div>
        </div>
        <div class="panel upload">
          <h2>Virus Scanning</h2>
          <div class="scan-grid">
            <div class="scan-row"><span>File</span><strong id="scan-file">-</strong></div>
            <div class="scan-row"><span>Result</span><strong id="scan-status">No scan yet</strong></div>
            <div class="scan-row"><span>Decision</span><strong id="scan-decision">-</strong></div>
            <div class="scan-row"><span>Risk score</span><strong id="scan-risk">-</strong></div>
            <div class="scan-row"><span>Engine</span><strong id="scan-engine">-</strong></div>
            <div class="scan-row"><span>Detail</span><strong id="scan-detail">-</strong></div>
            <div class="scan-row"><span>Deduplicated</span><strong id="scan-dedup">-</strong></div>
          </div>
          <div class="meta">
            <div>Result updates after each upload.</div>
          </div>
        </div>
      </section>

      <section id="project-docs" class="panel">
        <h2>Uploaded Files</h2>
        <p>Latest uploads stored in MongoDB.</p>
        <div class="list-header">
          <span>Filename</span>
          <span>Type</span>
          <span>Status</span>
        </div>
        <div class="list" id="uploads-list">
          <div class="list-item">Loading...</div>
        </div>
        <div id="dev-docs" class="dev-only">
          <p class="meta">
            Developer API docs: <a href="/docs">/docs</a>
          </p>
          <p class="meta">
            Project docs: README.md, PLAN.md, SECURITY.md, docs/*, sre/*, runbooks/*
          </p>
        </div>
      </section>

      <section class="cards">
        <div class="card">
          <h3>Uploads (24h)</h3>
          <p id="metric-uploads-24h">-</p>
        </div>
        <div class="card">
          <h3>Rejected (24h)</h3>
          <p id="metric-rejected-24h">-</p>
        </div>
        <div class="card">
          <h3>Rejection Rate (7d)</h3>
          <p id="metric-reject-rate-7d">-</p>
        </div>
        <div class="card">
          <h3>Average Risk (7d)</h3>
          <p id="metric-risk-7d">-</p>
        </div>
      </section>

      <footer>
        <p>Sentinel Upload API · NordTech AB · DevSecOps program</p>
      </footer>
    </main>

    <script>
      const dropzone = document.getElementById("dropzone");
      const input = document.getElementById("file-input");
      const uploadBtn = document.getElementById("upload-btn");
      const statusEl = document.getElementById("status");
      const scanFileEl = document.getElementById("scan-file");
      const scanStatusEl = document.getElementById("scan-status");
      const scanDecisionEl = document.getElementById("scan-decision");
      const scanRiskEl = document.getElementById("scan-risk");
      const scanEngineEl = document.getElementById("scan-engine");
      const scanDetailEl = document.getElementById("scan-detail");
      const scanDedupEl = document.getElementById("scan-dedup");
      const devDocsEl = document.getElementById("dev-docs");
      const metricUploads24hEl = document.getElementById("metric-uploads-24h");
      const metricRejected24hEl = document.getElementById("metric-rejected-24h");
      const metricRejectRate7dEl = document.getElementById("metric-reject-rate-7d");
      const metricRisk7dEl = document.getElementById("metric-risk-7d");

      const isDevHost =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1" ||
        window.location.hostname === "[::1]";
      if (isDevHost && devDocsEl) {
        devDocsEl.classList.add("is-visible");
      }
      function setStatus(message, type) {
        statusEl.textContent = message;
        statusEl.classList.remove("error", "warn");
        if (type) statusEl.classList.add(type);
      }

      function setScanResult(data) {
        scanFileEl.textContent = data.filename || "-";
        scanStatusEl.textContent = data.scan_status || "unknown";
        scanDecisionEl.textContent = data.decision || "-";
        scanRiskEl.textContent =
          typeof data.risk_score === "number" ? `${data.risk_score}/100` : "-";
        scanEngineEl.textContent = data.scan_engine || "-";
        scanDetailEl.textContent = data.scan_detail || "-";
        scanDedupEl.textContent = data.deduplicated ? "Yes" : "No";

        scanStatusEl.classList.remove("status-clean", "status-malicious", "status-error");
        scanDecisionEl.classList.remove("status-clean", "status-malicious", "status-review");

        if (data.scan_status === "clean") {
          scanStatusEl.classList.add("status-clean");
        } else if (data.scan_status === "malicious") {
          scanStatusEl.classList.add("status-malicious");
        } else {
          scanStatusEl.classList.add("status-error");
        }

        if (data.decision === "accepted") {
          scanDecisionEl.classList.add("status-clean");
        } else if (data.decision === "rejected") {
          scanDecisionEl.classList.add("status-malicious");
        } else if (data.decision === "review") {
          scanDecisionEl.classList.add("status-review");
        }
      }

      function setMetrics(data) {
        if (!data) return;
        const last24h = data.last_24h || {};
        const last7d = data.last_7d || {};
        metricUploads24hEl.textContent = `${last24h.total_uploads ?? 0}`;
        metricRejected24hEl.textContent = `${last24h.rejected ?? 0}`;
        metricRejectRate7dEl.textContent = `${last7d.rejection_rate_percent ?? 0}%`;
        metricRisk7dEl.textContent = `${last7d.avg_risk_score ?? 0}/100`;
      }

      function detailRow(label, value, valueClass) {
        const row = document.createElement("div");
        row.className = "scan-row";
        const labelEl = document.createElement("span");
        labelEl.textContent = label;
        const valueEl = document.createElement("strong");
        valueEl.textContent = value;
        if (valueClass) valueEl.classList.add(valueClass);
        row.appendChild(labelEl);
        row.appendChild(valueEl);
        return row;
      }

      dropzone.addEventListener("dragover", (event) => {
        event.preventDefault();
        dropzone.classList.add("dragover");
      });

      dropzone.addEventListener("dragleave", () => {
        dropzone.classList.remove("dragover");
      });

      dropzone.addEventListener("drop", (event) => {
        event.preventDefault();
        dropzone.classList.remove("dragover");
        if (event.dataTransfer.files.length) {
          input.files = event.dataTransfer.files;
          setStatus(`Selected ${input.files[0].name}`);
        }
      });

      // Avoid double file-picker dialogs on browsers that already trigger via <label for>.
      dropzone.addEventListener("click", (event) => {
        const target = event.target;
        const isLabelOrInput =
          target instanceof HTMLElement &&
          (target.tagName === "LABEL" || target.tagName === "INPUT");
        if (isLabelOrInput) return;
        input.click();
      });

      // Allow selecting the same file again after a previous upload.
      input.addEventListener("click", () => {
        input.value = "";
      });
      input.addEventListener("change", () => {
        if (input.files.length) {
          setStatus(`Selected ${input.files[0].name}`);
        }
      });

      async function loadUploads() {
        try {
          const response = await fetch("/uploads?limit=25");
          if (!response.ok) {
            throw new Error("Database unavailable");
          }
          const data = await response.json();
          const list = document.getElementById("uploads-list");
          list.innerHTML = "";
          if (!data.items.length) {
            list.innerHTML = '<div class="list-item">No uploads yet</div>';
            return;
          }
          data.items.forEach((item) => {
            const wrapper = document.createElement("div");
            wrapper.className = "upload-item";

            const row = document.createElement("div");
            row.className = "list-item list-item-toggle";
            row.setAttribute("role", "button");
            row.setAttribute("tabindex", "0");
            row.setAttribute("aria-expanded", "false");
            row.title = "Click to show scan details";
            const nameSpan = document.createElement("span");
            nameSpan.textContent = item.filename;
            const typeSpan = document.createElement("span");
            typeSpan.textContent = item.content_type;
            const statusSpan = document.createElement("span");
            statusSpan.textContent = item.status;
            if (item.status === "rejected") {
              statusSpan.classList.add("status-malicious");
            } else if (item.status === "accepted") {
              statusSpan.classList.add("status-clean");
            } else {
              statusSpan.classList.add("status-review");
            }
            row.appendChild(nameSpan);
            row.appendChild(typeSpan);
            row.appendChild(statusSpan);

            const details = document.createElement("div");
            details.className = "upload-details";
            details.hidden = true;
            details.style.display = "none";
            details.appendChild(detailRow("Result", item.scan_status || "unknown"));
            details.appendChild(detailRow("Decision", item.decision || "-", item.decision === "rejected" ? "status-malicious" : item.decision === "accepted" ? "status-clean" : "status-review"));
            details.appendChild(detailRow("Risk score", typeof item.risk_score === "number" ? `${item.risk_score}/100` : "-"));
            details.appendChild(detailRow("Engine", item.scan_engine || "-"));
            details.appendChild(detailRow("Detail", item.scan_detail || "-"));
            details.appendChild(detailRow("Deduplicated", item.deduplicated ? "Yes" : "No"));
            details.appendChild(detailRow("SHA-256", item.sha256 || "-"));

            const toggleDetails = () => {
              const isOpen = wrapper.classList.toggle("is-open");
              details.hidden = !isOpen;
              details.style.display = isOpen ? "grid" : "none";
              row.setAttribute("aria-expanded", isOpen ? "true" : "false");
              // Keep the side panel in sync with selected row.
              setScanResult(item);
            };
            row.addEventListener("click", toggleDetails);
            row.addEventListener("keydown", (event) => {
              if (event.key === "Enter" || event.key === " ") {
                event.preventDefault();
                toggleDetails();
              }
            });

            wrapper.appendChild(row);
            wrapper.appendChild(details);
            list.appendChild(wrapper);
          });
        } catch (error) {
          const list = document.getElementById("uploads-list");
          list.innerHTML = `<div class="list-item">${error.message}</div>`;
        }
      }

      async function loadMetrics() {
        try {
          const response = await fetch("/metrics/summary");
          if (!response.ok) {
            throw new Error("Metrics unavailable");
          }
          const data = await response.json();
          setMetrics(data);
        } catch (_error) {
          metricUploads24hEl.textContent = "-";
          metricRejected24hEl.textContent = "-";
          metricRejectRate7dEl.textContent = "-";
          metricRisk7dEl.textContent = "-";
        }
      }

      uploadBtn.addEventListener("click", async () => {
        if (!input.files.length) {
          setStatus("Choose a file first.", "warn");
          return;
        }

        const formData = new FormData();
        formData.append("file", input.files[0]);

        try {
          setStatus("Uploading...");
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.detail || "Upload failed");
          }
          setStatus(`Accepted: ${data.filename} (${data.content_type})`);
          setScanResult(data);
          await loadUploads();
          await loadMetrics();
        } catch (error) {
          setStatus(error.message, "error");
        }
      });

      loadUploads();
      loadMetrics();
    </script>
    <a
  class="bug-fab"
  href="https://github.com/Sidestep-Error/sentinel-upload-api/issues/new/choose"
  target="_blank"
  rel="noopener noreferrer"
  aria-label="Report a bug"
>
  Report bug
</a>

  </body>
</html>
